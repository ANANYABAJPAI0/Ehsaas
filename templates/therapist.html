<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MOH AIMate | Relationship Advisor</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #7042f8;
      --secondary: #8c52ff;
      --bg-dark: #12122e;
      --bg-light: #1c1c3c;
      --user-msg: #4C6F91;
      --bot-msg: #3a3a5c;
      --text: #eee;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Poppins', sans-serif;
      background: var(--bg-dark);
      color: var(--text);
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 100vh;
      overflow: hidden;
    }
    
    header {
      width: 100%;
      padding: 1rem;
      background: var(--bg-light);
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .logo {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--primary);
      margin-right: 8px;
    }
    
    h1 {
      font-size: 1.5rem;
      font-weight: 500;
    }
    
    #chat-container {
      flex: 1;
      width: 100%;
      max-width: 800px;
      overflow-y: auto;
      padding: 1rem;
      scrollbar-width: thin;
      scrollbar-color: var(--primary) var(--bg-light);
    }
    
    #chat-container::-webkit-scrollbar {
      width: 8px;
    }
    
    #chat-container::-webkit-scrollbar-thumb {
      background-color: var(--primary);
      border-radius: 4px;
    }
    
    .message-row {
      display: flex;
      margin-bottom: 1rem;
      animation: fadeIn 0.3s ease-in-out;
    }
    
    .message-row.user {
      justify-content: flex-end;
    }
    
    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      margin: 0 8px;
    }
    
    .user .avatar {
      background: var(--user-msg);
    }
    
    .bot .avatar {
      background: var(--primary);
    }
    
    .message {
      padding: 0.75rem 1rem;
      border-radius: 18px;
      max-width: 80%;
      line-height: 1.4;
    }
    
    .user .message {
      background: var(--user-msg);
      border-top-right-radius: 4px;
    }
    
    .bot .message {
      background: var(--bot-msg);
      border-top-left-radius: 4px;
    }
    
    .timestamp {
      font-size: 0.7rem;
      opacity: 0.7;
      margin-top: 4px;
      text-align: right;
    }
    
    #typing-indicator {
      display: none;
      margin-bottom: 1rem;
      align-items: center;
    }
    
    .typing-bubble {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: var(--text);
      margin: 0 2px;
      opacity: 0.7;
      animation: bounce 1.5s infinite;
    }
    
    .typing-bubble:nth-child(2) {
      animation-delay: 0.2s;
    }
    
    .typing-bubble:nth-child(3) {
      animation-delay: 0.4s;
    }
    
    #input-area {
      display: flex;
      width: 100%;
      max-width: 800px;
      padding: 1rem;
      background: var(--bg-light);
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    
    .input-wrapper {
      flex: 1;
      position: relative;
      margin-right: 0.5rem;
    }
    
    #message-input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: none;
      border-radius: 24px;
      background: rgba(255,255,255,0.1);
      color: #fff;
      font-family: inherit;
      outline: none;
      transition: box-shadow 0.3s;
    }
    
    #message-input:focus {
      box-shadow: 0 0 0 2px var(--primary);
    }
    
    button {
      border: none;
      border-radius: 50%;
      width: 42px;
      height: 42px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    #send-button {
      background: var(--primary);
      color: #fff;
      font-size: 1.2rem;
    }
    
    #mic-button {
      background: rgba(255,255,255,0.1);
      color: #fff;
      margin-right: 0.5rem;
    }
    
    #lang-toggle {
      background: rgba(255,255,255,0.1);
      color: #fff;
      margin-right: 0.5rem;
      font-size: 0.8rem;
    }
    
    button:hover {
      transform: scale(1.05);
    }
    
    button:active {
      transform: scale(0.95);
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes bounce {
      0%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-8px); }
    }
    
    /* Responsive */
    @media (max-width: 600px) {
      .message {
        max-width: 85%;
      }
      
      #input-area {
        padding: 0.75rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">ðŸ’œ</div>
    <h1>Saanjh | Your Friend</h1>
  </header>
  
  <div id="chat-container"></div>
  
  <div id="typing-indicator" class="message-row bot">
    <div class="avatar">AI</div>
    <div class="message">
      <div class="typing-bubble"></div>
      <div class="typing-bubble"></div>
      <div class="typing-bubble"></div>
    </div>
  </div>

  <div id="input-area">
    <button id="lang-toggle">EN</button>
    <div class="input-wrapper">
      <input
        id="message-input"
        type="text"
        placeholder="Type your message..."
        autocomplete="off"
      />
    </div>
    <button id="mic-button" title="Voice input">ðŸŽ¤</button>
    <button id="send-button" title="Send message">âž¤</button>
  </div>

  <script>
    const API_BASE = 'http://localhost:5000';      // <-- point to your Flask server
    const sessionId = Date.now().toString();       // simple session
    const username = localStorage.getItem('username') || '';

    const chatContainer = document.getElementById('chat-container');
    const typingIndicator = document.getElementById('typing-indicator');
    const inputEl = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-button');
    const micBtn = document.getElementById('mic-button');
    const langToggle = document.getElementById('lang-toggle');

    let currentLang = localStorage.getItem('preferredLang') || 'en-US';  // default

    // Update button text and save preference
    function updateLangUI() {
      langToggle.textContent = currentLang === 'en-US' ? 'EN' : 'HI';
      localStorage.setItem('preferredLang', currentLang);
    }

    langToggle.addEventListener('click', () => {
      currentLang = currentLang === 'en-US' ? 'hi-IN' : 'en-US';
      updateLangUI();
      if (recognizer) {
        recognizer.lang = currentLang;
      }
    });
    updateLangUI();

    // Format timestamp
    function getTimeString() {
      const now = new Date();
      return now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    // Append a chat bubble
    function appendMessage(text, sender) {
      const row = document.createElement('div');
      row.classList.add('message-row', sender === 'user' ? 'user' : 'bot');
      
      const avatar = document.createElement('div');
      avatar.classList.add('avatar');
      avatar.textContent = sender === 'user' ? 'YOU' : 'AI';
      
      const message = document.createElement('div');
      message.classList.add('message');
      message.textContent = text;
      
      const timestamp = document.createElement('div');
      timestamp.classList.add('timestamp');
      timestamp.textContent = getTimeString();
      
      message.appendChild(timestamp);
      row.appendChild(sender === 'user' ? document.createElement('div') : avatar);
      row.appendChild(message);
      row.appendChild(sender === 'user' ? avatar : document.createElement('div'));
      
      chatContainer.appendChild(row);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // Show typing indicator
    function showTyping(show) {
      typingIndicator.style.display = show ? 'flex' : 'none';
      if (show) {
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }
    }

    // Send user message to backend
    async function sendMessage() {
      const text = inputEl.value.trim();
      if (!text) return;
      
      // Disable input during processing
      inputEl.value = '';
      inputEl.disabled = true;
      sendBtn.disabled = true;
      micBtn.disabled = true;
      
      appendMessage(text, 'user');
      
      try {
        // Show typing indicator
        showTyping(true);
        
        // Parallel requests: One for typing indicator (allows server delay), one for actual response
        const typingPromise = fetch(`${API_BASE}/typing`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ message_length: text.length })
        });
        
        const responsePromise = fetch(`${API_BASE}/therapist`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ 
            message: text, 
            session_id: sessionId,
            username: username
          })
        });
        
        // Wait for typing indicator to complete first
        await typingPromise;
        
        // Then get the actual response
        const res = await responsePromise;
        if (!res.ok) throw new Error(res.statusText);
        
        const data = await res.json();
        
        // Hide typing indicator before showing message
        showTyping(false);
        
        // Simulate human typing delay based on message length
        const typingDelay = Math.min(1500, data.response.length * 20);
        setTimeout(() => {
          appendMessage(data.response, 'bot');
          speakText(data.response);
        }, typingDelay);
        
      } catch (err) {
        console.error(err);
        showTyping(false);
        appendMessage('I seem to be having connection issues. Can we try again?', 'bot');
      } finally {
        // Re-enable input controls
        setTimeout(() => {
          inputEl.disabled = false;
          sendBtn.disabled = false;
          micBtn.disabled = false;
          inputEl.focus();
        }, 500);
      }
    }

    sendBtn.addEventListener('click', sendMessage);
    inputEl.addEventListener('keydown', e => {
      if (e.key === 'Enter') sendMessage();
    });

    // Speech Recognition
    const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognizer;
    
    if (SpeechRec) {
      recognizer = new SpeechRec();
      recognizer.lang = currentLang;
      recognizer.continuous = false;
      recognizer.interimResults = false;
      recognizer.maxAlternatives = 1;

      recognizer.onstart = () => {
        micBtn.style.background = 'var(--primary)';
        micBtn.innerHTML = 'â¬¤';
      };
      
      recognizer.onresult = e => {
        const transcript = e.results[0][0].transcript;
        inputEl.value = transcript;
        setTimeout(sendMessage, 300); // Small delay to see the transcript
      };
      
      recognizer.onend = () => {
        micBtn.disabled = false;
        micBtn.style.background = 'rgba(255,255,255,0.1)';
        micBtn.innerHTML = 'ðŸŽ¤';
      };
      
      recognizer.onerror = (event) => {
        console.error('Speech recognition error', event.error);
        micBtn.disabled = false;
        micBtn.style.background = 'rgba(255,255,255,0.1)';
        micBtn.innerHTML = 'ðŸŽ¤';
      };
    }

    micBtn.addEventListener('click', () => {
      if (!recognizer) {
        return alert('Speech recognition is not supported in your browser.');
      }
      recognizer.lang = currentLang;
      micBtn.disabled = true;
      try {
        recognizer.start();
      } catch (err) {
        console.error('Speech recognition error on start:', err);
        micBtn.disabled = false;
      }
    });

    // Speech Synthesis
    function speakText(text) {
      if (!window.speechSynthesis) return;
      
      // Cancel any ongoing speech
      window.speechSynthesis.cancel();
      
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = currentLang;
      
      // Adjust voice settings for more natural speech
      utter.rate = 1.0;  // Speed (0.1 to 10)
      utter.pitch = 1.0; // Pitch (0 to 2)
      
      // Get appropriate voice if available
      const voices = window.speechSynthesis.getVoices();
      const preferredVoice = voices.find(voice => 
        voice.lang.includes(currentLang.substring(0, 2)) && 
        voice.name.includes('Female')
      );
      
      if (preferredVoice) {
        utter.voice = preferredVoice;
      }
      
      window.speechSynthesis.speak(utter);
    }

    // Load voices when available (Chrome needs this)
    if (window.speechSynthesis) {
      if (speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = () => {
          speechSynthesis.getVoices();
        };
      }
    }

    // Greet on load
    window.addEventListener('load', () => {
      setTimeout(() => {
        const greeting = "Hello! I'm Saanjh, your therapist. How can I help you today?";
        appendMessage(greeting, 'bot');
        
        // Speak greeting after a slight delay
        setTimeout(() => {
          speakText(greeting);
        }, 500);
      }, 800);
    });
  </script>
</body>
</html>